#pragma once

#include <cstddef>
#include <vector>
#include <unordered_map>

#ifdef _DEBUG
#define DEBUG(X) X
#else
#define DEBUG(X)
#endif

struct Function
{
    struct Block
    {
        size_t base{};
        size_t size{};
        size_t projectedSize{ static_cast<size_t>(-1) }; // scratch
        DEBUG(size_t parent{});

        Block() 
        {
        }

        Block(size_t base, size_t size)
            : base(base), size(size) 
        {
        }

        Block(size_t base, size_t size, size_t projectedSize) 
            : base(base), size(size), projectedSize(projectedSize)
        {
        }
    };

    size_t base{};
    size_t size{};
    std::vector<Block> blocks{};
    
    // Hash map for O(1) block lookups by base address
    std::unordered_map<size_t, size_t> blockMap{};

    Function()
    {
    }

    Function(size_t base, size_t size)
        : base(base), size(size)
    {
    }
    
    size_t SearchBlock(size_t address) const;
    
    // Add a block and update the hash map
    size_t AddBlock(size_t blockBase, size_t blockSize, size_t projectedSize = static_cast<size_t>(-1));
    
    static Function Analyze(const void* code, size_t size, size_t base);
};
